{% load static %}

{% block content %}
<h2>{% if is_edit %}Edit {% endif %}Laporan Harian Parkir</h2>

<!-- Flatpickr -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

<form method="post">
    {% csrf_token %}

    <fieldset>
        <legend>üìÖ Data Laporan</legend>

        <div style="margin-bottom: 15px;">
            <label>Tanggal</label><br>
            <input type="text" name="date" id="id_date" value="{{ report_form.date.value|default:'' }}"
                placeholder="dd/mm/yyyy" required>
        </div>
    </fieldset>

    <hr>

    <fieldset>
        <legend>üéüÔ∏è Pendapatan</legend>

        {{ ticket_formset.management_form }}

        <!-- Display non-field errors if any -->
        {% if ticket_formset.non_form_errors %}
        <div style="color:red;">{{ ticket_formset.non_form_errors }}</div>
        {% endif %}

        <table border="1" cellpadding="5" id="ticket-table" style="width: 100%; border-collapse: collapse;">
            <thead>
                <tr>
                    <th>Akun Pendapatan</th>
                    <th>Seri Awal</th>
                    <th>Seri Akhir</th>
                    <th>Lembar</th>
                    <th>Harga</th>
                    <th>Jumlah</th>
                    <th>Keterangan</th>
                    <th>Hapus</th>
                </tr>
            </thead>
            <tbody>
                {% for form in ticket_formset %}
                <tr class="ticket-form">
                    {% for hidden in form.hidden_fields %}{{ hidden }}{% endfor %}
                    <td>
                        {{ form.revenue_account }}
                        {% if form.revenue_account.errors %}<div style="color:red; font-size: 0.8em;">
                            {{form.revenue_account.errors }}</div>{% endif %}
                    </td>
                    <td>
                        {{ form.start_serial }}
                        {% if form.start_serial.errors %}<div style="color:red; font-size: 0.8em;">
                            {{form.start_serial.errors }}</div>{% endif %}
                    </td>
                    <td>
                        {{ form.end_serial }}
                        {% if form.end_serial.errors %}<div style="color:red; font-size: 0.8em;">
                            {{form.end_serial.errors }}</div>{% endif %}
                    </td>
                    <td>
                        {{ form.lembar }}
                        {% if form.lembar.errors %}<div style="color:red; font-size: 0.8em;">{{ form.lembar.errors }}
                        </div>{% endif %}
                    </td>
                    <td>
                        {{ form.price }}
                        {% if form.price.errors %}<div style="color:red; font-size: 0.8em;">{{ form.price.errors }}
                        </div>{% endif %}
                        ,</td>
                    <td><span class="subtotal" data-subtotal="0">0</span></td>
                    <td>
                        {{ form.description }}
                        {% if form.description.errors %}<div style="color:red; font-size: 0.8em;">
                            {{form.description.errors }}</div>{% endif %}
                    </td>
                    <td>
                        {% if ticket_formset.can_delete %}
                        {{ form.DELETE }}
                        {% endif %}
                        {% if form.non_field_errors %}<div style="color:red; font-size: 0.8em;">
                            {{form.non_field_errors}}</div>{% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <br>
        <button type="submit" name="add_ticket" value="1" formnovalidate
            style="padding: 8px 16px; background-color: #4CAF50; color: white; border: none; border-radius: 4px; cursor: pointer;">‚ûï
            Tambah Tiket</button>
    </fieldset>

    <hr>

    <fieldset>
        <legend>üí∏ Pengeluaran</legend>

        {{ expense_formset.management_form }}

        <table border="1" cellpadding="5">
            <thead>
                <tr>
                    <th>Akun Biaya</th>
                    <th>Keterangan</th>
                    <th>Persentase (%)</th>
                    <th>Unit</th>
                    <th>Nominal</th>
                    <th>Jumlah</th>
                    <th>Hapus</th>
                </tr>
            </thead>
            <tbody>
                {% for form in expense_formset %}
                <tr>
                    {% for hidden in form.hidden_fields %}
                        {{ hidden }}
                    {% endfor %}
                    <td>
                        {{ form.expense_account }}
                        {% if form.expense_account.errors %}
                            <div style="color:red; font-size: 0.8em;">{{ form.expense_account.errors }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {{ form.description }}
                        {% if form.description.errors %}
                            <div style="color:red; font-size: 0.8em;">{{ form.description.errors }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {{ form.percentage }}
                        {% if form.percentage.errors %}
                            <div style="color:red; font-size: 0.8em;">{{ form.percentage.errors }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {{ form.unit }}
                        {% if form.unit.errors %}
                            <div style="color:red; font-size: 0.8em;">{{ form.unit.errors }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {{ form.nominal }}
                        {% if form.nominal.errors %}
                            <div style="color:red; font-size: 0.8em;">{{ form.nominal.errors }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {{ form.amount }}
                        {% if form.amount.errors %}
                            <div style="color:red; font-size: 0.8em;">{{ form.amount.errors }}</div>
                        {% endif %}
                    </td>
                    <td>
                        {% if expense_formset.can_delete %}
                            {{ form.DELETE }}
                        {% endif %}
                        {% if form.non_field_errors %}
                            <div style="color:red; font-size: 0.8em;">{{ form.non_field_errors }}</div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <br>
        <button type="submit" name="add_expense" value="1" formnovalidate
            style="padding: 8px 16px; background-color: #FF9800; color: white; border: none; border-radius: 4px; cursor: pointer;">‚ûï
            Tambah Pengeluaran</button>
    </fieldset>

    <br>
    <button type="submit">üíæ Simpan Laporan</button>
</form>

<!-- JS -->
<script>
    /* Date Picker */
    flatpickr("#id_date", {
        dateFormat: "d/m/Y",
        allowInput: true
    });

    // Initialize ticket rows
    function initializeTicketRow(row) {
        const lembarInput = row.querySelector('[name*="-lembar"]');
        const priceInput = row.querySelector('[name*="-price"]');

        function updateSubtotal() {
            const price = parseFloat(priceInput ? priceInput.value : 0) || 0;
            const lembar = parseFloat(lembarInput ? lembarInput.value : 0) || 0;
            const subtotal = price * lembar;

            const subtotalSpan = row.querySelector('.subtotal');
            if (subtotalSpan) {
                subtotalSpan.textContent = subtotal.toLocaleString('id-ID', {
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                });
                subtotalSpan.setAttribute('data-subtotal', subtotal);
            }
        }

        if (lembarInput) {
            lembarInput.addEventListener('input', updateSubtotal);
        }
        if (priceInput) {
            priceInput.addEventListener('input', updateSubtotal);
        }

        // Initial Calculation
        updateSubtotal();
    }

    // Initialize existing rows
    document.querySelectorAll('.ticket-form').forEach((row) => {
        initializeTicketRow(row);
    });

    // Expense Calculation
    function initializeExpenseRow(row) {
        const percentageInput = row.querySelector('[name*="-percentage"]');
        const unitInput = row.querySelector('[name*="-unit"]');
        const nominalInput = row.querySelector('[name*="-nominal"]');
        const amountInput = row.querySelector('[name*="-amount"]');

        function calculateExpense() {
            const percentage = parseFloat(percentageInput.value) || 0;
            const unit = parseFloat(unitInput.value) || 0;
            const nominal = parseFloat(nominalInput.value) || 0;
            let amount = 0;

            if (percentage > 0) {
                amount = (percentage / 100) * nominal;
            } else if (unit > 0) {
                amount = unit * nominal;
            } else {
                // If neither percentage nor unit is set, explicitly checking for direct nominal entry 
                // might be desired, but user requirements say "jumlah adalah perkalian..."
                // However, usually if both are empty, user might want to input amount manually.
                // Assuming priority is given to calculation if inputs exist.
                // If user enters manually, this logic shouldn't overwrite it unless inputs change.
                return;
            }

            amountInput.value = amount;
        }

        if (percentageInput) percentageInput.addEventListener('input', calculateExpense);
        if (unitInput) unitInput.addEventListener('input', calculateExpense);
        if (nominalInput) nominalInput.addEventListener('input', calculateExpense);
    }

    // Initialize all existing expense rows (assuming they are in the table under "Pengeluaran")
    // Note: We need to target the rows in the second table. 
    // Since we didn't give the expense table an ID, lets find it or add a class.
    // The previous edit didn't add a class to expense tr. 
    // Let's assume we can select them via inputs. Or we can select the second table's rows.

    // Better strategy: Add a class to expense rows in the form html first for robustness?
    // Or just select all inputs with 'percentage' in name.
    document.querySelectorAll('[name*="-percentage"]').forEach(input => {
        const row = input.closest('tr');
        if (row) initializeExpenseRow(row);
    });
</script>

{% endblock %}